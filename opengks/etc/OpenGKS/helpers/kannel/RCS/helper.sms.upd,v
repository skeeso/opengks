head	1.1;
access;
symbols;
locks; strict;
comment	@# @;


1.1
date	2013.09.17.11.12.33;	author root;	state Exp;
branches;
next	;


desc
@@


1.1
log
@Initial revision
@
text
@#!/bin/bash
# $Id$
# $Source$
# DESC: HELPER - HELPER.SMS.UPD
# AUTHOR: Eric Fajardo / eric@@arpa.ph

# LOAD ENVIRONMENT VARIABLES
source /usr/local/bin/OpenGKS/prod.gencfvar.gk

# PARAMETERS
KEY1="$1"         # PRIMARY KEY
KEY2="$2"         # SECONDARY KEY
MSGS="$3"	  # MESSAGE
SNDR="$4"         # SENDER
RCPT="$5"         # RECIPIENT
STMP="$6"         # MSGSTAMP

KYKW=`echo "$KEY2" | sed 's/^...//'`
ITUN=`echo "$SNDR" | sed 's/^.*\(............\)$/\1/'`
KYID=`echo "$KEY2" | cut -c 1-3`
ENCD=`echo "$MSGS" | php -r "echo urldecode(file_get_contents('php://stdin'));"`
OKAY="Request completed. You may check it by requesting: GET $KYKW."
FAIL="Request denied. Do you have admin rights? Is your pin correct? Convince me, try: REQUEST<SPACE>PIN and I will email it to you."

for i in $ITUN
{
        export STMOBILE="`lynx -dump \"$USE_ADMURL?&refid=$i&query=stmobile\" | sed '/./!d' | awk '{print$1}'`"
	export STNAME="`lynx -dump \"$USE_ADMURL?&refid=$i&query=stname\" | sed '/./!d' | sed 's/^[ \t]*//;s/[ \t]*$//'`"
        export STPIN="`lynx -dump \"$USE_ADMURL?&refid=$i&query=stpin\" | sed '/./!d' | awk '{print$1}'`"
}

function onevent_postrequest(){
        if [[ "$USE_SENDSMSVIA" == "1" ]]; then
        $USE_BINPATH/prod.sendsms.gk --use-gsm-modem "$ITUN" "$OKAY"
      elif [[ "$USE_SENDSMSVIA" == "2" ]]; then
        $USE_BINPATH/prod.sendsms.gk --use-api-clickatell "$ITUN" "$OKAY"
      elif [[ "$USE_SENDSMSVIA" == "3" ]]; then
	$USE_BINPATH/prod.sendsms.gk --use-api-textity "$ITUN" "$OKAY"
      else
        printf "";
        fi
}

function onevent_requesterror(){
        if [[ "$USE_SENDSMSVIA" == "1" ]]; then
        $USE_BINPATH/prod.sendsms.gk --use-gsm-modem "$ITUN" "$FAIL"
      elif [[ "$USE_SENDSMSVIA" == "2" ]]; then
        $USE_BINPATH/prod.sendsms.gk --use-api-clickatell "$ITUN" "$FAIL"
      elif [[ "$USE_SENDSMSVIA" == "3" ]]; then
        $USE_BINPATH/prod.sendsms.gk --use-api-textity "$ITUN" "$FAIL"
      else
        printf "";
        fi
}

printf "\033[1mOpenGKS: - UPDSMS HELPER - `date`\033[0m\n\n";
		if [[ "$STMOBILE" == "$ITUN" ]] && \
		   [[ "$KYID" == "$STPIN" ]];then
			printf "[*] Verified request from $ITUN ...\n\n";
			echo "$KEY1 $KEY2 $ITUN $RCPT $STMP -- $MSGS" 
			$USE_MYSQL --user=$DEFINE_MYSQLU --password=$DEFINE_MYSQLP $DEFINE_MYSQLD -e \
				"UPDATE msgstore SET message='$ENCD', lastchange='`date`', lasteditor='$STNAME' WHERE name='$KYKW' AND onhold='0';"
			$USE_MYSQL --user=$DEFINE_MYSQLU --password=$DEFINE_MYSQLP $DEFINE_MYSQLD -e \
				"INSERT INTO logstore (eventname, eventlog, originator) VALUES ('GKS_POST', 'Posted. $KYKW. Content. $ENCD', 'Ref. $ITUN');"
			onevent_postrequest
	      else
			printf "[*] No records(s) in the database.\n";
			echo "$KEY1 $KEY2 $ITUN $RCPT $STMP -- $MSGS"
			$USE_MYSQL --user=$DEFINE_MYSQLU --password=$DEFINE_MYSQLP $DEFINE_MYSQLD -e \
                                "INSERT INTO logstore (eventname, eventlog, originator) VALUES ('GKS_POST', 'Failure. $KYKW. Content. $ENCD', 'Ref. $ITUN');"
			onevent_requesterror
		fi	

exit 0
@
